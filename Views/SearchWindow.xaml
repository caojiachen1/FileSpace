<ui:FluentWindow x:Class="FileSpace.Views.SearchWindow"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                xmlns:converters="clr-namespace:FileSpace.Converters"
                mc:Ignorable="d"
                Title="æ–‡ä»¶æœç´¢" 
                Width="800" 
                Height="600"
                MinWidth="600"
                MinHeight="400"
                WindowStartupLocation="CenterOwner"
                ExtendsContentIntoTitleBar="True"
                WindowBackdropType="Mica">
    
    <ui:FluentWindow.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <converters:FileSizeConverter x:Key="FileSizeConverter"/>
        <converters:FileIconConverter x:Key="FileIconConverter"/>
        <converters:BooleanToAdvancedOptionsTextConverter x:Key="BooleanToAdvancedOptionsTextConverter"/>
        
        <!-- Dark Mode Color Resources -->
        <SolidColorBrush x:Key="DarkBackgroundBrush" Color="#FF1E1E1E"/>
        <SolidColorBrush x:Key="DarkCardBackgroundBrush" Color="#FF2D2D30"/>
        <SolidColorBrush x:Key="DarkElevatedCardBackgroundBrush" Color="#FF363636"/>
        <SolidColorBrush x:Key="DarkTextPrimaryBrush" Color="#FFDEDEDE"/>
        <SolidColorBrush x:Key="DarkTextSecondaryBrush" Color="#FFDEDEDE"/>
        <SolidColorBrush x:Key="DarkTextMutedBrush" Color="#FF80DEDEDE"/>
        <SolidColorBrush x:Key="DarkBorderBrush" Color="#FF404040"/>
        
        <!-- Dark Mode DataGrid Style -->
        <Style x:Key="DarkDataGridStyle" TargetType="ui:DataGrid">
            <Setter Property="Background" Value="{StaticResource DarkCardBackgroundBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource DarkTextPrimaryBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource DarkBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="HorizontalGridLinesBrush" Value="{StaticResource DarkBorderBrush}"/>
            <Setter Property="VerticalGridLinesBrush" Value="Transparent"/>
            <Setter Property="RowBackground" Value="Transparent"/>
            <Setter Property="AlternatingRowBackground" Value="#FF252526"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="CanUserReorderColumns" Value="True"/>
            <Setter Property="CanUserResizeColumns" Value="True"/>
            <Setter Property="CanUserSortColumns" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
            <Setter Property="ScrollViewer.CanContentScroll" Value="True"/>
            <Setter Property="ScrollViewer.IsDeferredScrollingEnabled" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="ColumnWidth" Value="*"/>
        </Style>

        <!-- Dark Mode DataGridColumnHeader Style -->
        <Style x:Key="DarkDataGridColumnHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="{StaticResource DarkElevatedCardBackgroundBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource DarkTextPrimaryBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource DarkBorderBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Height" Value="40"/>
        </Style>
        
        <!-- Center Aligned DataGridCell Style -->
        <Style x:Key="CenterAlignedCellStyle" TargetType="DataGridCell">
            <Setter Property="TextBlock.TextAlignment" Value="Center"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        
        <!-- Left Aligned DataGridCell Style for text content -->
        <Style x:Key="LeftAlignedCellStyle" TargetType="DataGridCell">
            <Setter Property="TextBlock.TextAlignment" Value="Left"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
    </ui:FluentWindow.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="æ–‡ä»¶æœç´¢" ShowMinimize="True" ShowMaximize="True" ShowClose="True"/>
        
        <!-- æœç´¢æ¡ä»¶åŒºåŸŸ -->
        <Border Grid.Row="1" 
                Background="{DynamicResource ApplicationBackgroundBrush}"
                Padding="16"
                Margin="8,8,8,4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- åŸºæœ¬æœç´¢é€‰é¡¹ -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- æœç´¢è·¯å¾„ -->
                    <TextBlock Grid.Row="0" Grid.Column="0" 
                               Text="æœç´¢è·¯å¾„:" 
                               VerticalAlignment="Center" 
                               Margin="0,0,8,0"/>
                    <ui:TextBox Grid.Row="0" Grid.Column="1" 
                                Text="{Binding SearchPath, UpdateSourceTrigger=PropertyChanged}"
                                Margin="0,0,8,8"/>
                    <ui:Button Grid.Row="0" Grid.Column="2" 
                               Content="æµè§ˆ..."
                               Command="{Binding BrowseSearchPathCommand}"
                               Margin="0,0,0,8"/>
                    
                    <!-- æœç´¢å†…å®¹ -->
                    <TextBlock Grid.Row="1" Grid.Column="0" 
                               Text="æœç´¢å†…å®¹:" 
                               VerticalAlignment="Center" 
                               Margin="0,0,8,0"/>
                    <ui:TextBox Grid.Row="1" Grid.Column="1" 
                                Text="{Binding SearchPattern, UpdateSourceTrigger=PropertyChanged}"
                                Grid.ColumnSpan="2"
                                Margin="0,0,0,8">
                        <ui:TextBox.InputBindings>
                            <KeyBinding Key="Enter" Command="{Binding StartSearchCommand}"/>
                        </ui:TextBox.InputBindings>
                    </ui:TextBox>
                    
                    <!-- æœç´¢é€‰é¡¹ -->
                    <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" 
                                Orientation="Horizontal">
                        <CheckBox Content="æ–‡ä»¶" 
                                  IsChecked="{Binding SearchFiles}"
                                  Margin="0,0,16,0"/>
                        <CheckBox Content="æ–‡ä»¶å¤¹" 
                                  IsChecked="{Binding SearchDirectories}"
                                  Margin="0,0,16,0"/>
                        <CheckBox Content="å­ç›®å½•" 
                                  IsChecked="{Binding IncludeSubdirectories}"
                                  Margin="0,0,16,0"/>
                        <CheckBox Content="åŒºåˆ†å¤§å°å†™" 
                                  IsChecked="{Binding CaseSensitive}"
                                  Margin="0,0,16,0"/>
                        <CheckBox Content="ä½¿ç”¨é€šé…ç¬¦" 
                                  IsChecked="{Binding UseWildcards}"
                                  Margin="0,0,16,0"/>
                        <CheckBox Content="æ­£åˆ™è¡¨è¾¾å¼" 
                                  IsChecked="{Binding UseRegex}"
                                  Margin="0,0,16,0"/>
                    </StackPanel>
                </Grid>
                
                <!-- é«˜çº§é€‰é¡¹åˆ‡æ¢ -->
                <ui:Button Grid.Row="1" 
                           Content="{Binding ShowAdvancedOptions, Converter={StaticResource BooleanToAdvancedOptionsTextConverter}}"
                           Command="{Binding ToggleAdvancedOptionsCommand}"
                           HorizontalAlignment="Left"
                           Margin="0,8,0,0"/>
                
                <!-- é«˜çº§æœç´¢é€‰é¡¹ -->
                <Grid Grid.Row="2" 
                      Visibility="{Binding ShowAdvancedOptions, Converter={StaticResource BooleanToVisibilityConverter}}"
                      Margin="0,8,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- æ–‡ä»¶æ‰©å±•å -->
                    <TextBlock Grid.Row="0" Grid.Column="0" 
                               Text="æ–‡ä»¶æ‰©å±•å (ç”¨é€—å·åˆ†éš”):"
                               Margin="0,0,8,4"/>
                    <ui:TextBox Grid.Row="0" Grid.Column="1" 
                                Text="{Binding FileExtensions}"
                                PlaceholderText="å¦‚: txt,pdf,docx (ä¸éœ€è¦è¾“å…¥ç‚¹å·)"
                                Margin="8,0,0,8"/>
                    
                    <!-- æ–‡ä»¶å¤§å°èŒƒå›´ -->
                    <TextBlock Grid.Row="1" Grid.Column="0" 
                               Text="æ–‡ä»¶å¤§å°èŒƒå›´:"
                               Margin="0,0,8,4"/>
                    <StackPanel Grid.Row="1" Grid.Column="1" 
                                Orientation="Horizontal"
                                Margin="8,0,0,8">
                        <ui:TextBox Text="{Binding MinSize}" 
                                    PlaceholderText="å¦‚: 1MB, 500KB"
                                    Width="100"
                                    Margin="0,0,8,0"/>
                        <TextBlock Text="åˆ°" 
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <ui:TextBox Text="{Binding MaxSize}" 
                                    PlaceholderText="å¦‚: 100MB, 1GB"
                                    Width="100"/>
                    </StackPanel>
                    
                    <!-- ä¿®æ”¹æ—¶é—´èŒƒå›´ -->
                    <TextBlock Grid.Row="2" Grid.Column="0" 
                               Text="ä¿®æ”¹æ—¶é—´èŒƒå›´:"
                               Margin="0,0,8,4"/>
                    <StackPanel Grid.Row="2" Grid.Column="1" 
                                Orientation="Horizontal"
                                Margin="8,0,0,8">
                        <DatePicker SelectedDate="{Binding ModifiedAfter}" 
                                    Width="120"
                                    Margin="0,0,8,0"
                                    ToolTip="å¼€å§‹æ—¥æœŸ"/>
                        <TextBlock Text="åˆ°" 
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <DatePicker SelectedDate="{Binding ModifiedBefore}" 
                                    Width="120"
                                    ToolTip="ç»“æŸæ—¥æœŸ"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
        
        <!-- æœç´¢æŽ§åˆ¶æŒ‰é’® -->
        <Border Grid.Row="2" 
                Background="{DynamicResource ApplicationBackgroundBrush}"
                Padding="16,8"
                Margin="8,0,8,4">
            <StackPanel Orientation="Horizontal">
                <ui:Button Content="å¼€å§‹æœç´¢" 
                           Command="{Binding StartSearchCommand}"
                           Appearance="Primary"
                           Margin="0,0,8,0"/>
                <ui:Button Content="å–æ¶ˆæœç´¢" 
                           Command="{Binding CancelSearchCommand}"
                           Margin="0,0,8,0"/>
                <ui:Button Content="æ¸…é™¤ç»“æžœ" 
                           Command="{Binding ClearResultsCommand}"
                           Margin="0,0,16,0"/>
                
                <!-- è¿›åº¦æ˜¾ç¤º -->
                <StackPanel Orientation="Horizontal" 
                            Visibility="{Binding IsSearching, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding SearchStatus}" 
                               VerticalAlignment="Center"/>
                </StackPanel>
            </StackPanel>
        </Border>
        
        <!-- æœç´¢ç»“æžœåˆ—è¡¨ -->
        <Border Grid.Row="3" 
                Background="{DynamicResource ApplicationBackgroundBrush}"
                Margin="8,0,8,4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- ç»“æžœæ ‡é¢˜ -->
                <TextBlock Grid.Row="0" 
                           Text="{Binding SearchResults.Count, StringFormat='æœç´¢ç»“æžœ ({0} é¡¹)'}"
                           FontWeight="Bold"
                           Margin="16,16,16,8"/>
                
                <!-- ç»“æžœåˆ—è¡¨ -->
                <ui:DataGrid Grid.Row="1" 
                             ItemsSource="{Binding SearchResults}"
                             SelectedItem="{Binding SelectedResult}"
                             IsReadOnly="True"
                             VerticalScrollBarVisibility="Auto"
                             Style="{StaticResource DarkDataGridStyle}"
                             ColumnHeaderStyle="{StaticResource DarkDataGridColumnHeaderStyle}"
                             Margin="8">
                    <ui:DataGrid.Columns>
                        <DataGridTemplateColumn Header="åç§°" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸ“" Margin="0,0,8,0" Visibility="{Binding IsDirectory, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        <TextBlock Text="ðŸ“„" Margin="0,0,8,0" Visibility="{Binding IsDirectory, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                        <TextBlock Text="{Binding Name}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="è·¯å¾„" Width="3*" Binding="{Binding FullPath}" CellStyle="{StaticResource LeftAlignedCellStyle}"/>
                        <DataGridTextColumn Header="å¤§å°" Width="*" Binding="{Binding Size, Converter={StaticResource FileSizeConverter}}" CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                        <DataGridTextColumn Header="ä¿®æ”¹æ—¶é—´" Width="*" Binding="{Binding ModifiedTime}" CellStyle="{StaticResource CenterAlignedCellStyle}"/>
                        <DataGridTemplateColumn Header="æ“ä½œ" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <ui:Button Content="ðŸ” æ‰“å¼€" 
                                                   Command="{Binding DataContext.OpenResultCommand, RelativeSource={RelativeSource AncestorType=ui:DataGrid}}"
                                                   Margin="2" Padding="8,4" FontSize="11"/>
                                        <ui:Button Content="ðŸ“‚ å®šä½" 
                                                   Command="{Binding DataContext.OpenInExplorerCommand, RelativeSource={RelativeSource AncestorType=ui:DataGrid}}"
                                                   Margin="2" Padding="8,4" FontSize="11"/>
                                        <ui:Button Content="ðŸ“‹ æ˜¾ç¤º" 
                                                   Command="{Binding DataContext.ShowInMainWindowCommand, RelativeSource={RelativeSource AncestorType=ui:DataGrid}}"
                                                   Margin="2" Padding="8,4" FontSize="11"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </ui:DataGrid.Columns>
                    
                    <!-- ä¸Šä¸‹æ–‡èœå• -->
                    <ui:DataGrid.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="æ‰“å¼€" 
                                      Command="{Binding OpenResultCommand}"/>
                            <MenuItem Header="åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ˜¾ç¤º" 
                                      Command="{Binding OpenInExplorerCommand}"/>
                            <MenuItem Header="åœ¨ä¸»çª—å£ä¸­æ˜¾ç¤º" 
                                      Command="{Binding ShowInMainWindowCommand}"/>
                        </ContextMenu>
                    </ui:DataGrid.ContextMenu>
                    
                    <!-- åŒå‡»äº‹ä»¶ -->
                    <ui:DataGrid.InputBindings>
                        <MouseBinding MouseAction="LeftDoubleClick" 
                                      Command="{Binding OpenResultCommand}"/>
                    </ui:DataGrid.InputBindings>
                </ui:DataGrid>
            </Grid>
        </Border>
        
        <!-- çŠ¶æ€æ  -->
        <Border Grid.Row="4" 
                Background="{DynamicResource ApplicationBackgroundBrush}"
                Padding="16,8"
                Margin="8,0,8,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0" 
                           Text="{Binding SearchStatus}"
                           VerticalAlignment="Center"/>
                
                <ProgressBar Grid.Column="1" 
                             Width="200"
                             Height="4"
                             Value="{Binding SearchProgress}"
                             Visibility="{Binding IsSearching, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>
